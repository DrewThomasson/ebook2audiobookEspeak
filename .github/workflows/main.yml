name: Test Across Multiple Systems Without sudo

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu:latest, fedora:latest, archlinux:latest, alpine:latest, opensuse/leap:latest]
        scenario: [none, calibre, ffmpeg, both]
    container:
      image: ${{ matrix.os }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Install Dependencies (Ubuntu)
        if: ${{ matrix.os == 'ubuntu:latest' }}
        run: |
          echo "::group::Installing Dependencies for Ubuntu"
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y calibre ffmpeg espeak-ng python3-pip -qq
          pip install gradio bs4 pydub nltk ebooklib tqdm
          python3 -m nltk.downloader punkt
          echo "::endgroup::"

      - name: Install Dependencies (Fedora)
        if: ${{ matrix.os == 'fedora:latest' }}
        run: |
          echo "::group::Installing Dependencies for Fedora"
          dnf install -y calibre ffmpeg espeak-ng python3-pip -q
          pip install gradio bs4 pydub nltk ebooklib tqdm
          python3 -m nltk.downloader punkt
          echo "::endgroup::"

      - name: Install Dependencies (Arch)
        if: ${{ matrix.os == 'archlinux:latest' }}
        run: |
          echo "::group::Installing Dependencies for Arch"
          pacman -Sy --noconfirm calibre ffmpeg espeak-ng python-pip
          pip install gradio bs4 pydub nltk ebooklib tqdm
          python -m nltk.downloader punkt
          echo "::endgroup::"

      - name: Install Dependencies (Alpine)
        if: ${{ matrix.os == 'alpine:latest' }}
        run: |
          echo "::group::Installing Dependencies for Alpine"
          apk add --no-cache bash python3 py3-pip ffmpeg espeak-ng
          pip install gradio bs4 pydub nltk ebooklib tqdm
          python3 -m nltk.downloader punkt
          echo "::endgroup::"

      - name: Install Dependencies (openSUSE)
        if: ${{ matrix.os == 'opensuse/leap:latest' }}
        run: |
          echo "::group::Installing Dependencies for openSUSE"
          zypper install -y calibre ffmpeg espeak-ng python3-pip
          pip install gradio bs4 pydub nltk ebooklib tqdm
          python3 -m nltk.downloader punkt
          echo "::endgroup::"

      - name: Create and Run Test Script
        run: |
          echo "::group::Running Test Script"
          cat << 'EOF' > test_script.sh
          #!/bin/bash
          set -e
          python3 gradio_launch.py &
          sleep 5
          if curl -s http://localhost:7860 | grep "Gradio"; then
            echo "Gradio interface running successfully."
            exit 0
          else
            echo "Failed to launch Gradio interface."
            exit 1
          fi
          EOF
          chmod +x test_script.sh
          ./test_script.sh
          echo "::endgroup::"
        shell: bash
